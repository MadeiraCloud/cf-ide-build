/*
   flip - v1.0.0 - 2015-04-04
  * https://github.com/nnattawat/flip
  * Copyright (c) 2015 Nattawat Nonsung; Licensed MIT
   */

(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d;o=window.location;if(/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/.exec(o.hostname)){void 0;return}s=o.hostname.split("."),s.length>=3?window.MC_DOMAIN=s[s.length-2]+"."+s[s.length-1]:window.MC_DOMAIN=o.hostname,window.MC_API_HOST=o.protocol+"//api."+window.MC_DOMAIN,window.language=window.version="";if(o.hostname.toLowerCase().indexOf("cloudfielder.com")>=0&&o.protocol==="http:"){window.location=o.href.replace("http:","https:");return}return $.cookie("usercode")&&$.cookie("session")&&(window.location.href="/"),!function(e){var t=function(e){e.data("fliped",!0);var t="rotate"+e.data("axis");e.find(".front").css({transform:t+(e.data("reverse")?"(-180deg)":"(180deg)")}),e.find(".back").css({transform:t+"(0deg)"})},n=function(e){e.data("fliped",!1);var t="rotate"+e.data("axis");e.find(".front").css({transform:t+"(0deg)"}),e.find(".back").css({transform:t+(e.data("reverse")?"(180deg)":"(-180deg)")})};e.fn.flip=function(r){return this.each(function(){var i=e(this);if(void 0!==r&&"boolean"==typeof r)r?t(i):n(i);else{var s=e.extend({axis:"y",reverse:!1,trigger:"click",speed:500},r);if(i.data("reverse",s.reverse),i.data("axis",s.axis),"x"==s.axis.toLowerCase())var o=2*i.outerHeight(),u="rotatex";else var o=2*i.outerWidth(),u="rotatey";i.find(".back").css({transform:u+"("+(s.reverse?"180deg":"-180deg")+")"}),i.css({perspective:o,position:"relative"});var a=s.speed/1e3||.5;if(i.find(".front, .back").outerWidth(i.width()).css({"transform-style":"preserve-3d",transition:"all "+a+"s ease-out","backface-visibility":"hidden"}),"click"==s.trigger.toLowerCase())i.find('button, a, input[type="submit"]').click(function(e){e.stopPropagation()}),i.click(function(){i.data("fliped")?n(i):t(i)});else if("hover"==s.trigger.toLowerCase()){var f=function(){i.unbind("mouseleave",l),t(i),setTimeout(function(){i.bind("mouseleave",l),i.is(":hover")||n(i)},s.speed+150)},l=function(){n(i)};i.mouseenter(f),i.mouseleave(l)}}}),this}}(jQuery),$(".input-wrap").append("<div class='error'></div>"),$(".form").on("keypress","input",function(e){var t;if(e.keyCode!==13)return;return t=$(e.currentTarget).parents(".input-wrap").next(),t.length?t.find("input").focus():$(e.delegateTarget).find("button.action").click(),!1}),e=function(e,t,n){return $.ajax({url:MC_API_HOST+e,dataType:"json",type:"POST",jsonp:!1,data:JSON.stringify({jsonrpc:"2.0",id:"1",method:t||"",params:n})}).then(function(e,t){var n,r,i;try{e=e.result,r=e[0],i=e[1];if(r!==0)throw n=new Error(i),n.error=r,n;return i}catch(s){return n=s,$("button.action").each(function(e,t){return p(t,!1)}),$.Deferred().reject(n).promise()}},function(e,t){return $(".network-error").show(),$("button.action").each(function(e,t){return p(t,!1)}),$.Deferred().reject().promise()})},r=function(t,n,r){return r==null&&(r="CF"),e("/session/","login",[t,n,null,r]).then(function(e){var t;t={expires:30,path:"/"},$.cookie("usercode",e.username,t),$.cookie("session",e.session_id,t),$.cookie("accountDomain",r,t)})},d={},f=function(e){var t;t=$(".select-account-domain");if(!e)return t.removeClass("conflict").find("input").get(0).checked=!0;if(!t.hasClass("conflict"))return t.addClass("conflict").find("input").get(0).checked=!1},t=function(t){return d[t]!==void 0?f(d[t]):e("/account/","is_cf_domain",[t]).then(function(e){return d[t]=e,f(e)})},i=function(e){var t;return t=$(e).find("input"),t.filter(function(e,t){return t.value}).removeClass("ipt-error").siblings(".error").empty(),t.filter(function(e,t){return!t.value}).addClass("ipt-error").siblings(".error").html("You can't leave this empty.").length===0},p=function(e,t){var n;n=$(e),t?n.attr("disabled","disabled").html(n.attr("data-loading")):n.removeAttr("disabled").html(n.attr("data-normal"))},h=function(e,t){return t?($(e).addClass("ipt-error").siblings(".error").html(t),!0):($(e).removeClass("ipt-error").siblings(".error").html(),!1)},a=window.location.pathname,a.indexOf("/login")===0?$("body").addClass("bd-login"):a.indexOf("/register")===0?($("body").addClass("bd-signup"),$(".signup-card").flip({trigger:"manual"})):a.indexOf("/reset")===0&&($("body").addClass("bd-reset"),c=a.replace(/^\/reset/,"reset").replace(/\/$/,"").split("/"),$(".reset-card").flip({trigger:"manual"}),c.length===2&&($("body").addClass("bd-reset-token"),l=c[1],e("/account/","check_validation",[l,"reset"]).then(function(e){return $("body").addClass("bd-reset-checked")},function(e){if(!e)return $("body").addClass("bd-reset-checked");if(e.error===321||e.error===320)return $("body").addClass("bd-reset-invalid")}))),$("#actReset").click(function(){var t;$(".network-error").hide();if(!i(".reset-card-email"))return;t=$("#iptReset");if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t.val())){h(t,"Please provide a valid email.");return}return h(t),p("#actReset",!0),e("/account/","reset_password",[t.val()]).then(function(e){return $(".reset-card-email").flip(!0)},function(e){if(!e)return;h("#iptReset","Failed to reset your password, please make sure your email address is correct.")})}),$("#actResetPass").click(function(){var t,n,r;$("#network-error").hide();if(!i(".reset-card-password"))return;t=$("#iptResetPass"),t.val().length<6?r=h(t,"Password must contain 6 characters at least."):h(t,""),n=$("#iptResetPass2"),n.val()!==t.val()?r=h(n,"These passwords don't match."):h(n,"");if(r)return;return p("#actResetPass",!0),e("/account/","update_password",[l,t.val()]).then(function(e){return $(".reset-card-password").flip(!0)},function(e){if(e.error===321||e.error===320)$("body").addClass("bd-reset-invalid"),$("body").removeClass("bd-reset-checked")})}),$("#actLogin").click(function(){var e;$(".network-error").hide();if(!i(".form-wrap.login"))return;return p("#actLogin",!0),e=$("#use-visualops-account").get(0).checked?"VO":"CF",r($("#iptLoginName").val(),$("#iptLoginPass").val(),e).then(function(){return window.location.href="/"},function(e){if(!e)return;h("#iptLoginPass","Incorrect username or password.")})}),$("#iptLoginName").blur(function(e){var n;n=e.currentTarget.value;if(!n)return;return t(n)}),u=!1,n=!1,$("#actLaunch").on("click",function(){u?window.location.href="/":(n=!0,$(evt.currentTarget).html("Just a second..."))}),$("#actRegister").click(function(){var t,s,o,a;$(".network-error").hide();if(!i(".form-wrap.signup"))return;a=!1,t=$("#iptRegisterEmail"),/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t.val())?h(t):a=h(t,"Please provide a valid email."),s=$("#iptRegisterPass"),s.val().length<6?a=h(s,"Password must contain 6 characters at least."):h(s,""),o=$("#iptRegisterPass2"),o.val()!==s.val()?a=h(o,"These passwords don't match."):h(o,"");if(a)return;return p("#actRegister",!0),e("/account/","register",[$("#iptRegisterName").val(),$("#iptRegisterPass").val(),$("#iptRegisterEmail").val(),{first_name:$("#iptRegisterFN").val(),last_name:$("#iptRegisterLN").val(),timezone:8}]).then(function(e){$(".signup-card").flip(!0),r($("#iptRegisterName").val(),$("#iptRegisterPass").val()).then(function(){n?window.location.href="/":u=!0})},function(e){if(!e)return;return e.error===118?h($("#iptRegisterName"),"The username has already been registered."):e.error===117&&h($("#iptRegisterEmail"),"The email has already been registered."),void 0})})})();