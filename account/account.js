/*
   flip - v1.0.0 - 2015-04-04
  * https://github.com/nnattawat/flip
  * Copyright (c) 2015 Nattawat Nonsung; Licensed MIT
   */

(function(){var e,t,n,r,i,s,o,u,a,f,l,c;s=window.location;if(/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/.exec(s.hostname)){void 0;return}i=s.hostname.split("."),i.length>=3?window.MC_DOMAIN=i[i.length-2]+"."+i[i.length-1]:window.MC_DOMAIN=s.hostname,window.MC_API_HOST=s.protocol+"//api."+window.MC_DOMAIN,window.language=window.version="";if(s.hostname.toLowerCase().indexOf("cloudfielder.io")>=0&&s.protocol==="http:"){window.location=s.href.replace("http:","https:");return}return $.cookie("usercode")&&$.cookie("session")&&(window.location.href="/"),!function(e){var t=function(e){e.data("fliped",!0);var t="rotate"+e.data("axis");e.find(".front").css({transform:t+(e.data("reverse")?"(-180deg)":"(180deg)")}),e.find(".back").css({transform:t+"(0deg)"})},n=function(e){e.data("fliped",!1);var t="rotate"+e.data("axis");e.find(".front").css({transform:t+"(0deg)"}),e.find(".back").css({transform:t+(e.data("reverse")?"(180deg)":"(-180deg)")})};e.fn.flip=function(r){return this.each(function(){var i=e(this);if(void 0!==r&&"boolean"==typeof r)r?t(i):n(i);else{var s=e.extend({axis:"y",reverse:!1,trigger:"click",speed:500},r);if(i.data("reverse",s.reverse),i.data("axis",s.axis),"x"==s.axis.toLowerCase())var o=2*i.outerHeight(),u="rotatex";else var o=2*i.outerWidth(),u="rotatey";i.find(".back").css({transform:u+"("+(s.reverse?"180deg":"-180deg")+")"}),i.css({perspective:o,position:"relative"});var a=s.speed/1e3||.5;if(i.find(".front, .back").outerWidth(i.width()).css({"transform-style":"preserve-3d",transition:"all "+a+"s ease-out","backface-visibility":"hidden"}),"click"==s.trigger.toLowerCase())i.find('button, a, input[type="submit"]').click(function(e){e.stopPropagation()}),i.click(function(){i.data("fliped")?n(i):t(i)});else if("hover"==s.trigger.toLowerCase()){var f=function(){i.unbind("mouseleave",l),t(i),setTimeout(function(){i.bind("mouseleave",l),i.is(":hover")||n(i)},s.speed+150)},l=function(){n(i)};i.mouseenter(f),i.mouseleave(l)}}}),this}}(jQuery),$(".input-wrap").append("<div class='error'></div>"),$(".form").on("keypress","input",function(e){var t;if(e.keyCode!==13)return;return t=$(e.currentTarget).parents(".input-wrap").next(),t.length?t.find("input").focus():$(e.delegateTarget).find("button.action").click(),!1}),e=function(e,t,n){return $.ajax({url:MC_API_HOST+e,dataType:"json",type:"POST",jsonp:!1,data:JSON.stringify({jsonrpc:"2.0",id:"1",method:t||"",params:n})}).then(function(e,t){var n,r,i;try{e=e.result,r=e[0],i=e[1];if(r!==0)throw n=new Error(i),n.error=r,n;return i}catch(s){return n=s,$("button.action").each(function(e,t){return c(t,!1)}),$.Deferred().reject(n).promise()}},function(e,t){return $(".network-error").show(),$("button.action").each(function(e,t){return c(t,!1)}),$.Deferred().reject().promise()})},n=function(t,n){return e("/session/","login",[t,n]).then(function(e){var t;t={expires:30,path:"/"},$.cookie("usercode",e.username,t),$.cookie("session",e.session_id,t)})},r=function(e){var t;return t=$(e).find("input"),t.filter(function(e,t){return t.value}).removeClass("ipt-error").siblings(".error").empty(),t.filter(function(e,t){return!t.value}).addClass("ipt-error").siblings(".error").html("You can't leave this empty.").length===0},c=function(e,t){var n;n=$(e),t?n.attr("disabled","disabled").html(n.attr("data-loading")):n.removeAttr("disabled").html(n.attr("data-normal"))},l=function(e,t){return t?($(e).addClass("ipt-error").siblings(".error").html(t),!0):($(e).removeClass("ipt-error").siblings(".error").html(),!1)},u=window.location.pathname,u.indexOf("/login")===0?$("body").addClass("bd-login"):u.indexOf("/register")===0?($("body").addClass("bd-signup"),$(".signup-card").flip({trigger:"manual"})):u.indexOf("/reset")===0&&($("body").addClass("bd-reset"),f=u.replace(/^\/reset/,"reset").replace(/\/$/,"").split("/"),$(".reset-card").flip({trigger:"manual"}),f.length===2&&($("body").addClass("bd-reset-token"),a=f[1],e("/account/","check_validation",[a,"reset"]).then(function(e){return $("body").addClass("bd-reset-checked")},function(e){if(!e)return $("body").addClass("bd-reset-checked");if(e.error===321||e.error===320)return $("body").addClass("bd-reset-invalid")}))),$("#actReset").click(function(){var t;$(".network-error").hide();if(!r(".reset-card-email"))return;t=$("#iptReset");if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t.val())){l(t,"Please provide a valid email.");return}return l(t),c("#actReset",!0),e("/account/","reset_password",[t.val()]).then(function(e){return $(".reset-card-email").flip(!0)},function(e){if(!e)return;l("#iptReset","Failed to reset your password, please make sure your email address is correct.")})}),$("#actResetPass").click(function(){var t,n,i;$("#network-error").hide();if(!r(".reset-card-password"))return;t=$("#iptResetPass"),t.val().length<6?i=l(t,"Password must contain 6 characters at least."):l(t,""),n=$("#iptResetPass2"),n.val()!==t.val()?i=l(n,"These passwords don't match."):l(n,"");if(i)return;return c("#actResetPass",!0),e("/account/","update_password",[a,t.val()]).then(function(e){return $(".reset-card-password").flip(!0)},function(e){if(e.error===321||e.error===320)$("body").addClass("bd-reset-invalid"),$("body").removeClass("bd-reset-checked")})}),$("#actLogin").click(function(){$(".network-error").hide();if(!r(".form-wrap.login"))return;return c("#actLogin",!0),n($("#iptLoginName").val(),$("#iptLoginPass").val()).then(function(){return window.location.href="/"},function(e){if(!e)return;l("#iptLoginPass","Incorrect username or password.")})}),o=!1,t=!1,$("#actLaunch").on("click",function(){o?window.location.href="/":(t=!0,$(evt.currentTarget).html("Just a second..."))}),$("#actRegister").click(function(){var i,s,u,a;$(".network-error").hide();if(!r(".form-wrap.signup"))return;a=!1,i=$("#iptRegisterEmail"),/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(i.val())?l(i):a=l(i,"Please provide a valid email."),s=$("#iptRegisterPass"),s.val().length<6?a=l(s,"Password must contain 6 characters at least."):l(s,""),u=$("#iptRegisterPass2"),u.val()!==s.val()?a=l(u,"These passwords don't match."):l(u,"");if(a)return;return c("#actRegister",!0),e("/account/","register",[$("#iptRegisterName").val(),$("#iptRegisterPass").val(),$("#iptRegisterEmail").val(),{first_name:$("#iptRegisterFN").val(),last_name:$("#iptRegisterLN").val(),timezone:8}]).then(function(e){$(".signup-card").flip(!0),n($("#iptRegisterName").val(),$("#iptRegisterPass").val()).then(function(){t?window.location.href="/":o=!0})},function(e){if(!e)return;return e.error===118?l($("#iptRegisterName"),"The username has already been registered."):e.error===117&&l($("#iptRegisterEmail"),"The email has already been registered."),void 0})})})();